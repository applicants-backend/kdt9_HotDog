<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../images/HotDog-Logo.png" type="image/x-icon" sizes="32x32">
  <title>용품 나눔</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="../css/hospital.css">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/share.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">로고</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="btns" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">산책친구 찾기</a>
          </li>


          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              게시판
            </a>
            <ul class="dropdown-menu">

              <li><a class="dropdown-item" href="#">용품나눔</a></li>
              <li><a class="dropdown-item" href="#">나의 펫을 자랑합니다</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">강아지 찾기</a>
          </li>
          
          <li class="nav-item">
            <a class="nav-link" href="#">Q&A</a>
          </li>
          
        </ul>
      </div>
      <div class="myLog">
        <button class="btn_my" type="button">마이페이지</button>
        <button class="btn_log" type="button">로그인</button>
      </div>
    </div>
  </nav>

  
  <button type="button" class="btn btn-primary write-button-container" data-bs-toggle="modal"
    data-bs-target="#exampleModal">
    글쓰기
  </button>
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">게시글 작성</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="write-form">
            <label for="userid">작성자</label>
            <input type="text" id="userid" /><br />
            <label for="title">제목</label>
            <input type="text" id="title" placeholder="제목" /><br />
            <label for="content">내용</label>
            <textarea type="text" id="content" placeholder="내용"></textarea><br />
            <label for="dynamic_file"></label>
            <input type='file' id="dynamic_file" accept='image/jpg, image/png, image/jpeg' />

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" onclick="writeShare()" data-bs-dismiss="modal" class="btn btn-primary">작성완료</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <div class="container">
    <div class="row">
      <!-- 데이터를 동적으로 렌더링 -->
      <% if (data.length > 0) { %>
        <% for (let i = 0; i < data.length; i++) { %>
        <div class="col-md-4 mb-4">
          <div class="card">
            <% if(data[i].dynamic_file) { %>
              <div class="card-img-container"><img src="<%= data[i].dynamic_file %>" alt="게시글 이미지" class="card-img-top"></div>
              <% } else { %>
              <div class="card-img-container"><img src="../images/Labrador.avif" alt="게시글 이미지" class="card-img-top"></div>
              <% } %>            
              <div class="card-body">
              <h5 class="card-title">
                <%= data[i].title %>
              </h5>
              <p class="card-text">
                <%= data[i].content %>
              </p>
              <p class="card-text"><small class="text-muted"><strong>작성자:</strong>
                  <%= data[i].userid %>
                </small></p>
              <p class="card-text"><small class="text-muted"><strong>userid:</strong>
                  <%= data[i].writer %>
                </small></p>
              <p class="card-text"><small class="text-muted"><strong>날짜:</strong>
                  <%= data[i].createdAt.toLocaleString('ko-KR', { year: 'numeric' , month: '2-digit' , day: '2-digit' ,
                    hour: '2-digit' , minute: '2-digit' }) %>
                </small></p>
            </div>
            <div class="card-footer text-center">
                <button id="editBtn"  type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal_<%= data[i].id %>">수정</button>
                <button id="deleteBtn"  type="button" onclick="deleteShare('<%= data[i].id %>')" class="btn btn-danger">삭제</button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#commentModal_<%= data[i].id %>">댓글 작성</button>
            </div>
          </div>
        </div>
      <% } %>
      <% } else { %>
        <div class="col-12">
          <p>데이터가 없습니다.</p>
        </div>
      <% } %>
    </div>
  </div>

  <% for (let i=0; i < data.length; i++) { %>
  <div class="modal fade" id="editModal_<%= data[i].id %>" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">게시글 변경</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-form_<%= data[i].id %>"">
            <label for="userid">작성자</label>
            <input type="text" id="userid" /><br />
            <label for="title">제목</label>
            <input type="text" id="title" /><br />
            <label for="content">내용</label>
            <textarea type="text" id="content"></textarea><br />
            <label for="dynamic_file"></label>
            <input type='file' id="dynamic_file" accept='image/jpg, image/png, image/jpeg' />
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" onclick="editShare('<%= data[i].id %>')" class="btn btn-primary" data-bs-dismiss="modal">변경완료</button>
        </div>
      </form>
      </div>

      </div>
    </div>
  </div>
  <% } %>

  <% for (let i = 0; i < data.length; i++) { %>
    <!-- 댓글 작성 모달 -->
    <div class="modal fade" id="commentModal_<%= data[i].id %>" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="commentModalLabel">댓글 작성</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- 댓글 목록 -->
            <div id="comments_<%= data[i].id %>" class="comments-list">
              <% if (data[i].comments) { %>
                <% data[i].comments.forEach((comment) => { %>
                  <div id="comment_<%= comment.id %>" class="comment-item">
                    <strong class="comment-writer"><%= comment.writer %>:</strong>
                    <span class="comment-content"><%= comment.content %></span>
                    <button onclick="deleteComment('<%= comment.id %>')" class="comment-delete-btn">삭제</button>
                  </div>
                <% }) %>
              <% } else { %>
                <p>댓글이 없습니다.</p>
              <% } %>
            </div>
            <!-- 댓글 작성 폼 -->
            <form id="comment-form_<%= data[i].id %>" class="comment-form">
              <label for="comment">댓글</label>
              <textarea type="text" id="comment" class="comment-textarea"></textarea>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" onclick="writeComment('<%= data[i].id %>')" class="btn btn-primary">작성완료</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  <% } %>
  
  <footer>
    <div class="footer-container">
      <div class="footer-container-1">
        <a href="#" onclick="scrollToTop()">사이트맵</a>
        <a href="#">FAQ</a>
        <a href="#">웹사이트</a>
        <div class="copyright">&copy; 2023 Hotdog. All rights reserved.</div>
      </div>
      <div div class="footer-container-2">
        <div>김민현</div>
        <div>김대원</div>
        <div>강석주</div>
        <div>이영경</div>
        <div>김명준</div>
      </div>
    </div>
  </footer>

  <script>
    console.log("Token from localStorage:", window.localStorage.getItem('token'));

      const editBtn = document.getElementById("editBtn");
      const deleteBtn = document.getElementById("deleteBtn");
      const writer=document.querySelector('#writer')
      const token = window.localStorage.getItem('token')
      const data={token,writer};
     axios({
        method:'POST',
        url:'/share/verify',
        data
    }).then((res)=>{
        console.log(res);
        if(!res.data.data){
            editBtn.style.display='none'
            deleteBtn.style.display='none'
        }
    })
    //  async function verify(writer) {


      //const id=document.querySelector('#writer')
     
    //   try {
    //     const res = await axios({
    //       method: 'POST',
    //       url: "/share/verify",
    //       data
    //     })
    //     console.log(res.data.data);
    //     if (!res.data.data) {
    //       alert(`${res.data.message}`)
    //     }

    //   } catch (error) {

    //   }
    // }
    // verify();


    const userid = document.querySelector('#userid')
    const title = document.querySelector('#title')
    const content = document.querySelector('#content')
    const body = document.querySelector('tbody')
    const tbody = document.querySelector('#tbody');

    // const token=localStorage.getItem('token');

    async function writeShare() {
      const token = window.localStorage.getItem("token");
      event.preventDefault();
      console.log(token);
                if (!token) {
                    alert("로그인 해주세요.");
                    return;
                }

      const userid = document.querySelector('#userid').value;
      const title = document.querySelector('#title').value;
      const content = document.querySelector('#content').value;
      const fileInput = document.querySelector('#dynamic_file');
      

      const formData = new FormData();
      formData.append('userid', userid);
      formData.append('title', title);
      formData.append('content', content);
      formData.append('dynamic_file', fileInput.files[0]);
      formData.append('token', token)
      console.log(formData)
      try {
        const response = await axios({
          method: 'POST',
          url: '/share/shareCommit',
          data: formData,
          headers: {
            'Content-Type': 'multipart/form-data',
          },

        });
        console.log(response.data)
        console.log(response.data.result)
        alert('등록되었습니다.');
        window.location.reload()
        if (response.data.result) {
          console.log(response.data)
        }
      } catch (error) {
        console.error('오류 발생:', error);
      }
    }

    async function editShare(id) {
      const form = document.forms['edit-form_' + id];
      if (!confirm('수정 하시겠습니까?')) {
        return;
      }
      try {
        const res = await axios({
          method: 'PATCH',
          url: `/share/edit/${id}`,
          data: {
            id: Number(id),
            userid: form.userid.value,
            title: form.title.value,
            content: form.content.value,
          },
        });
        if (res.data.result) {
          alert(`변경 완료되었습니다.`);
          window.location.reload();
        }
      } catch (error) {
        console.log(error);
      }
    }


    async function deleteShare(id) {
      if (!confirm('삭제 하시겠습니까?')) {
        return
      }
      try {
        const res = await axios({
          method: 'DELETE',
          url: '/share/delete',
          data: {
            id: Number(id),
          }
        });
        if (res.data.result) {
          alert(`삭제되었습니다.`)
          window.location.reload()
        }
      } catch (error) {
        console.log(error)
      }

      console.log(first)
    }


// 댓글 작성
async function writeComment(postId, token) {
  console.log(token);
                if (!token) {
                    alert("로그인 해주세요.");
                    return;
                }
  const content = document.getElementById('comment').value;
  if (!content) {
    alert('댓글을 입력해주세요.');
    return;
  }

  try {
    const res = await axios({
      method: 'POST',
      url: `/share/comments/${postId}`,
      data: {
        content: content,
        token: token
      }
    });

    if (res.data.result) {
      alert('댓글이 작성되었습니다.');
      window.location.reload();
    }
  } catch (error) {
    console.error(error);
  }
}

async function deleteComment(commentId, token) {
  if (!confirm('댓글을 삭제하시겠습니까?')) {
    return;
  }

  try {
    const res = await axios({
      method: 'DELETE',
      url: `/share/comments/${commentId}`,
      data: {
        token: token
      }
    });

    if (res.data.result) {
      alert('댓글이 삭제되었습니다.');
      window.location.reload();
    }
  } catch (error) {
    console.error(error);
  }
}

    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: "smooth" // 부드러운 스크롤 효과를 사용하려면 "smooth"를 설정합니다.
      });
    }
        

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>

</body>

</html>