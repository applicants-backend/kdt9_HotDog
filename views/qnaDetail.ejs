<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="icon" href="/images/7Tf1NS6R.ico" type="image/x-icon" sizes="32x32">
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" /> -->
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="/css/qnaDetail.css">
    <link rel="icon" href="../images/HotDog-Logo.png" type="image/x-icon" sizes="32x32">
    <title>게시글 상세 조회</title>
</head>
    <title>Q&A</title>
</head>

<body>
    <nav>
        <div>
        </div>
    </nav>
    <div class="container">
        <h1>Q&A</h1>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button id="editBtn" class="btn btn-primary" type="button" onclick="edit()">수정</button>
                <button id="deleteBtn" class="btn btn-danger" type="button" onclick="deleteBoards()">삭제</button>
            </div>
            <div class="writer">
                <label for="writer">작성자</label>
                <input type="text" id="writer" class="form-control" value="<%=data.writer%>" readonly>
            </div>
        </div>
        <label for="title">제목</label>
        <input type="text" id="title" class="form-control" value="<%=data.title%>"><br>
        <label for="contents">내용</label><br>
        <textarea id="contents" class="form-control" rows="10"><%=data.contents%></textarea>
        <button type="button" onclick="location.href='/boards/qna'">목록으로</button>
    </div>
    <div class="toggleBtn_listBtn">
    <button id="toggleCommentButton" class="btn btn-primary" onclick="toggleCommentForm()">댓글 보기</button>
</div>
    <div id="comment-container" class="comment-container"><br>
        <!-- <div class="comment-list"></div> -->
        <input type="hidden" id="boardtype" value="qna" />
        <input type="hidden" id="id" value="<%=data.id%>" />
        <input type="hidden" id="writer_other" value="<%=data.writer%>" readonly>
        <div class="form-group">
            <label for="comment-content">댓글</label><br>
            <textarea id="comment-content" class="form-control" rows="4" placeholder="댓글을 입력하세요"></textarea>
            <button class="btn btn-primary" onclick="postComment()">댓글 작성</button>
            <div id="commentarea"></div>
        </div>
    </div>
</div>
</body>

<script>
    // 댓글 입력 폼을 토글하는 함수
    function toggleCommentForm() {
        var commentContainer = document.querySelector('#commentarea');
        var commentContainers = document.querySelector("#comment-container")
        if (commentContainer.style.display === 'none' || commentContainer.style.display === '' ||commentContainers.style.display === 'none' || commentContainers.style.display === '') {
            commentContainer.style.display = 'block';
            commentContainers.style.display = 'block';
        } else {
            commentContainer.style.display = 'none';
            commentContainers.style.display = 'none';
        }
    }
    // 스크롤 대상 엘리먼트
var commentContainer = document.querySelector("#comment-container");

// 주기적으로 스크롤 대상 업데이트
setInterval(function() {
    commentContainer = document.querySelector("#comment-container");
}, 1000);

// 스크롤 부드럽게 이동하는 함수
function scrollToCommentContainer() {
    if (commentContainer) {
        commentContainer.scrollIntoView({ behavior: "smooth" });
    }
}
document.getElementById("toggleCommentButton").addEventListener("click", scrollToCommentContainer);

    const token = localStorage.getItem('token');
    const writer = document.querySelector('#writer').value
    const editBtn = document.getElementById("editBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const data = { token, writer };
    axios({
        method: 'POST',
        url: '/boards/verify',
        data
    }).then((res) => {
        console.log(res);
        if (!res.data.data) {
            editBtn.style.display = 'none'
            deleteBtn.style.display = 'none'
        }
    })
    axios({
        method: 'GET',
        url: `/boards/comment/${document.getElementById("id").value}`
    }).then(res => {
        console.log(res.data);
        const commentarea = document.querySelector('#commentarea'); // 댓글을 표시할 요소 선택
        res.data.comments.forEach(value => {
            const paragraph = document.createElement('p'); // <p> 요소 생성
            paragraph.textContent = `${value.writerid}님의 댓글: ${value.content}`;
            commentarea.appendChild(paragraph); // 각 댓글을 별도의 <p> 요소로 추가
        });
    });
    async function edit() {
        const id = document.getElementById("id").value;
        const title = document.getElementById("title").value;
        const contents = document.getElementById("contents").value;
        console.log(id)
        console.log(title)
        console.log(contents)
        try {
            if (!confirm("수정 하시겠습니까?")) {
                return;
            }
            const data = {
                id: Number(id),
                title: title,
                contents: contents,
            };
            const res = await axios({
                method: "PATCH",
                url: `/boards/qna/${id}`,
                data,
            })
            if (res.data.data) {
                alert(`${res.data.message}`);
                document.location.href = '/boards/qna';
            }
        } catch (error) {
            console.error(error);
            alert("수정 중 오류가 발생했습니다.");
        }
    }

    async function deleteBoards() {
        const id = document.getElementById("id").value;
        const data = { id }

        if (!confirm("삭제 하시겠습니까?")) {
            return;
        }

        try {
            const res = await axios({
                method: "DELETE",
                url: `/boards/qna/${id}`,
                data
            })
            console.log(res.data)
            if (res.data.data) {
                alert("삭제가 완료되었습니다.");
                document.location.href = '/boards/qna';
                return;
            }
        } catch (error) {
            console.error(error);
            alert("삭제 중 오류가 발생했습니다.");
            document.location.href = '/boards/qna';
            return;
        }
    }

    async function verify(writer) {
        const token = window.localStorage.getItem('token')
        //const id=document.querySelector('#writer')
        const data = {
            token, writer
        }
        try {
            const res = await axios({
                method: 'POST',
                url: "/boards/verify",
                data
            })
            console.log(res.data.data);
            if (!res.data.data) {
                alert(`${res.data.message}`)
                document.location.href = '/boards/qna'
            }

        } catch (error) {

        }
    }
    const b_t = document.querySelector('#boardtype')
    const writer_other = document.querySelector('#writer_other')
    const contents = document.querySelector('#comment-content')
    const commentarea = document.querySelector('#commentarea');
    const div = document.createElement('div')
    div.style.whiteSpace = 'pre-wrap';
    async function postComment() {
        const id = document.getElementById("id").value;
        const commentContent = contents.value.trim();
        console.log(b_t, writer, contents)
        if (!commentContent.trim()) { // 댓글 내용이 비어있을 때
        alert('댓글을 입력하세요.');
        return;
    }
        const data = {
            writerid: writer_other.value,
            content: contents.value,
            boardtype: b_t.value,
            id
        }
        try {
            const res = await axios({
                method: 'POST',
                url: '/boards/comment/',
                data
            })
            if (res.data.data) {
                div.textContent += `${res.data.id}님의 댓글:${res.data.contents}\n`
                commentarea.append(div);
                contents.value = '';
                location.reload();
            }

        } catch (error) {
            console.log(error);
        }
    }
</script>

</html>